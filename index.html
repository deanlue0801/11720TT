<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÜäÁ™©Âú∞Âúñ - Âç≥ÊôÇÂçî‰ΩúÁâà</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #2c3e50;
            font-family: 'Courier New', monospace;
            color: #ecf0f1;
            overflow: auto;
            /* üî• Á¶ÅÊ≠¢ÊâãÊ©üÂéüÁîüÁ∏ÆÊîæ */
            touch-action: pan-x pan-y;
            user-select: none;
        }
        
        .controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            margin: 0;
            padding: 8px;
            background: rgba(52, 73, 94, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 0;
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(127, 140, 141, 0.3);
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .controls {
                padding: 5px;
                gap: 3px;
                font-size: 11px;
            }
            
            .controls input, .controls select {
                font-size: 12px;
                padding: 4px;
                min-width: 60px;
                /* üî• Â¢ûÂä†Ëß∏ÊéßÂçÄÂüü */
                min-height: 44px;
            }
            
            .controls button {
                font-size: 11px;
                padding: 4px 6px;
                /* üî• Á¢∫‰øùÊåâÈàïÂ§†Â§ß */
                min-height: 44px;
                min-width: 44px;
            }
            
            .info {
                font-size: 10px;
                margin-left: 5px;
            }
        }
        
        .controls input, .controls select {
            padding: 5px;
            background: #2c3e50;
            border: 1px solid #7f8c8d;
            color: #ecf0f1;
            border-radius: 3px;
        }
        
        .controls button {
            padding: 5px 10px;
            background: #27ae60;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .controls button:hover {
            background: #2ecc71;
        }
        
        .controls button:active {
            transform: scale(0.95);
            background: #229954;
        }
        
        .controls button.debug {
            background: #f39c12;
        }
        
        .controls button.debug:hover {
            background: #e67e22;
        }
        
        .status {
            background: #e74c3c;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .status.connected {
            background: #27ae60;
        }
        
        .info {
            margin-left: auto;
            font-size: 12px;
            color: #95a5a6;
        }
        
        .map-container {
            position: relative;
            width: 10000px;
            height: 8000px;
            margin: 0;
            background: #34495e;
            border: none;
            cursor: crosshair;
            overflow: visible;
            transition: transform 0.3s ease;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .person {
            position: absolute;
            color: #ffffff;
            font-size: 10px;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            cursor: move;
            border-radius: 3px;
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            z-index: 10;
            transform: rotate(45deg);
            box-sizing: border-box;
            transition: all 0.2s ease;
            
            /* üî• ÊâãÊ©üËß∏ÊéßÂÑ™Âåñ */
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .person .text {
            transform: rotate(-45deg);
        }
        
        .person:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }
        
        /* üéØ Ëß∏ÊéßÁãÄÊÖãÂÑ™Âåñ */
        .person:active,
        .person.touch-active {
            background: rgba(52, 152, 219, 0.5) !important;
            border-color: #3498db !important;
            transform: rotate(45deg) scale(1.1);
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.6);
            z-index: 1000;
            cursor: grabbing;
        }
        
        .person.dragging {
            background: rgba(231, 76, 60, 0.5) !important;
            border-color: #e74c3c !important;
            z-index: 1001;
            transform: rotate(45deg) scale(1.15);
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.8);
            cursor: grabbing;
            
            /* üî• ÊãñÊãΩÊôÇÁöÑËÑàË°ùÂãïÁï´ */
            animation: dragPulse 0.8s ease-in-out infinite alternate;
        }
        
        @keyframes dragPulse {
            from { 
                box-shadow: 0 0 25px rgba(231, 76, 60, 0.8);
            }
            to { 
                box-shadow: 0 0 35px rgba(231, 76, 60, 1);
            }
        }
        
        .person.green {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
            color: #ffffff;
        }
        
        .person.blue {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
            color: #ffffff;
        }
        
        .person.purple {
            background: rgba(155, 89, 182, 0.2);
            border-color: #9b59b6;
            color: #ffffff;
        }
        
        .person.orange {
            background: rgba(230, 126, 34, 0.2);
            border-color: #e67e22;
            color: #ffffff;
        }
        
        .person.pink {
            background: rgba(233, 30, 99, 0.2);
            border-color: #e91e63;
            color: #ffffff;
        }
        
        .person.yellow {
            background: rgba(241, 196, 15, 0.2);
            border-color: #f1c40f;
            color: #ffffff;
        }
        
        .person.cyan {
            background: rgba(26, 188, 156, 0.2);
            border-color: #1abc9c;
            color: #ffffff;
        }
        
        .person.red {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            color: #ffffff;
        }
        
        .coords {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 10px;
            color: #7f8c8d;
            pointer-events: none;
            z-index: 5;
            background: rgba(44, 62, 80, 0.8);
            padding: 5px;
            border-radius: 3px;
        }
        
        .grid-info {
            position: fixed;
            top: 60px;
            left: 5px;
            font-size: 10px;
            color: #95a5a6;
            pointer-events: none;
            z-index: 5;
            background: rgba(44, 62, 80, 0.8);
            padding: 5px;
            border-radius: 3px;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: none;
            z-index: 15;
        }
        
        .person:hover .delete-btn,
        .person:active .delete-btn,
        .person.touch-active .delete-btn {
            display: block;
        }
        
        /* üéØ Ëß∏ÊéßÊèêÁ§∫ */
        .touch-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(52, 73, 94, 0.95);
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 2000;
            display: none;
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .touch-hint.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        /* üî• ÊâãÊ©üÁî®Êà∂Â∞àÁî®ÊèêÁ§∫ */
        .mobile-tips {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 73, 94, 0.9);
            color: #ecf0f1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            opacity: 0.8;
        }
        
        @media (min-width: 769px) {
            .mobile-tips {
                display: none;
            }
        }
        
        /* üéØ ÊãñÊãΩÊèêÁ§∫Á∑ö */
        .drag-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(231, 76, 60, 0.6);
            border-radius: 50%;
            pointer-events: none;
            z-index: 999;
            animation: trailFade 1s ease-out forwards;
        }
        
        @keyframes trailFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }
    </style>
</head>
<body>
    <div class="controls">
        <input type="text" id="newItemName" placeholder="Ëº∏ÂÖ•ÂêçÁ®±" />
        <select id="itemType">
            <option value="person">ÊàêÂì° (2√ó2=4Ê†º)</option>
            <option value="small">Â∞èÂª∫ÁØâ (1√ó1=1Ê†º)</option>
            <option value="center">‰∏≠ÂøÉÂª∫ÁØâ (3√ó3=9Ê†º)</option>
            <option value="large">Â§ßÂª∫ÁØâ (4√ó4=16Ê†º)</option>
        </select>
        <select id="itemColor">
            <option value="green">Á∂†Ëâ≤</option>
            <option value="blue">ËóçËâ≤</option>
            <option value="purple">Á¥´Ëâ≤</option>
            <option value="orange">Ê©òËâ≤</option>
            <option value="pink">Á≤âËâ≤</option>
            <option value="yellow">ÈªÉËâ≤</option>
            <option value="cyan">ÈùíËâ≤</option>
            <option value="red">Á¥ÖËâ≤</option>
        </select>
        <button onclick="addItem()">Êñ∞Â¢ûÈ†ÖÁõÆ</button>
        <button onclick="exportLayout()">ÂåØÂá∫Â∫ß‰ΩçË°®</button>
        <button onclick="clearAll()" style="background: #c0392b;">‚ö†Ô∏è Ê∏ÖÁ©∫ÊâÄÊúâ</button>
        <button onclick="zoomIn()" class="debug">ÊîæÂ§ß (+)</button>
        <button onclick="zoomOut()" class="debug">Á∏ÆÂ∞è (-)</button>
        <button onclick="resetZoom()" class="debug">ÈáçÁΩÆÁ∏ÆÊîæ</button>
        <div class="status" id="connectionStatus">Êú™ÈÄ£Êé•</div>
        <div class="info">
            Âç≥ÊôÇÂçî‰ΩúÁâà | Âè≥ÈçµÊîπËÆäÈ°èËâ≤ | Á∏ÆÊîæ: <span id="zoomLevel">100%</span> | ÁõÆÂâçÈ†ÖÁõÆ: <span id="peopleCount">0</span>
        </div>
    </div>
    
    <div class="map-container" id="mapContainer">
        <div class="grid-overlay" id="gridOverlay"></div>
        <div class="coords" id="coords">Â∫ßÊ®ô: 0, 0</div>
        <div class="grid-info">‚ö†Ô∏è ËºâÂÖ•‰∏≠...</div>
    </div>
    
    <!-- üî• ÊâãÊ©üËß∏ÊéßÊèêÁ§∫ -->
    <div class="mobile-tips">
        üí° Èï∑ÊåâÊãñÊãΩÈ†ÖÁõÆ | Âè≥ÈçµÊîπËâ≤ | Ctrl+ÊªæËº™Á∏ÆÊîæ
    </div>
    
    <!-- üéØ Ëß∏ÊéßÊèêÁ§∫ÂΩàÁ™ó -->
    <div class="touch-hint" id="touchHint">
        <div>üéØ Ê≠£Âú®ÊãñÊãΩ</div>
        <div style="font-size: 12px; margin-top: 5px;">ÁßªÂãïÂà∞ÁõÆÊ®ô‰ΩçÁΩÆÂæåÊîæÈñã</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // üî• ‰Ω†ÁöÑ Firebase ÈÖçÁΩÆ (Ê≠£Á¢∫ÁöÑ Database URL)
        const firebaseConfig = {
            apiKey: "AIzaSyBHG_bYTMT9s9XkeU5s1LIanFiZDN-081w",
            authDomain: "sky-bb549.firebaseapp.com",
            databaseURL: "https://sky-bb549-default-rtdb.firebaseio.com/", // ‚úÖ Ê≠£Á¢∫ÁöÑ URL
            projectId: "sky-bb549",
            storageBucket: "sky-bb549.firebasestorage.app",
            messagingSenderId: "105237288983",
            appId: "1:105237288983:web:5dcec35e9306d043a96452",
            measurementId: "G-9FZNC307GC"
        };

        // Initialize Firebase
        let app, database, isFirebaseEnabled = false;
        
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            isFirebaseEnabled = true;
            updateConnectionStatus('Â∑≤ÈÄ£Êé•', true);
        } catch (error) {
            console.warn('Firebase Êú™Ê≠£Á¢∫Ë®≠ÂÆö:', error);
            updateConnectionStatus('ÈúÄË¶ÅË®≠ÂÆö Firebase', false);
        }

        // ÂÖ®ÂüüËÆäÊï∏
        const GRID_SIZE = 40;
        const MAP_WIDTH = 10000;
        const MAP_HEIGHT = 8000;
        const GRID_ORIGIN_X = MAP_WIDTH / 2;
        const GRID_ORIGIN_Y = MAP_HEIGHT / 2;
        
        // ‚úÖ ‰øÆÊ≠£ÔºöÂàùÂßãÁÇ∫Á©∫Èô£ÂàóÔºåÁ≠â Firebase ËºâÂÖ•
        let people = [];
        
        // È†êË®≠Ë≥áÊñôÔºåÂè™Âú® Firebase Ê≤íÊúâË≥áÊñôÊôÇ‰ΩøÁî®
        const defaultPeople = [
            {name: 'ÁÜäÁ™©', gridX: 0, gridY: 0, type: 'center', color: 'red'},
            {name: 'ÊÄ•ÂÖàÈãí', gridX: 0, gridY: -3, type: 'person', color: 'green'},
            {name: 'Patato Q', gridX: 3, gridY: -1, type: 'person', color: 'blue'},
            {name: 'Potato Sue', gridX: 3, gridY: 1, type: 'person', color: 'purple'}
        ];
        
        let isDragging = false;
        let dragPerson = null;
        let dragOffset = {x: 0, y: 0};
        let zoomLevel = 1.0;
        let isUpdatingFromFirebase = false;
        let hasLoadedFromFirebase = false; // ‚úÖ Êñ∞Â¢ûÔºöËøΩËπ§ÊòØÂê¶Â∑≤Âæû Firebase ËºâÂÖ•
        
        // üî• Êñ∞Â¢ûËß∏ÊéßÁõ∏ÈóúËÆäÊï∏
        let touchStartTime = 0;
        let longPressTimer = null;
        let currentTouchTarget = null;
        
        // üîê Êñ∞Â¢ûÔºöÁ∑®ËºØÂØÜÁ¢º‰øùË≠∑
        let isAuthenticated = false;
        const EDIT_PASSWORD = "bearDen2025"; // ‰Ω†ÂèØ‰ª•‰øÆÊîπÈÄôÂÄãÂØÜÁ¢º
        
        // üîß ÊâãÊ©üÈô§ÈåØÈ°ØÁ§∫
        function updateDebugInfo(message) {
            const debugEl = document.querySelector('.grid-info');
            if (debugEl) {
                debugEl.innerHTML = message;
            }
        }

        // üîê ÂØÜÁ¢ºÈ©óË≠âÂáΩÊï∏
        function checkEditPassword() {
            if (isAuthenticated) return true;
            
            const passwordInput = prompt('üîê Ë´ãËº∏ÂÖ•Á∑®ËºØÂØÜÁ¢ºÔºö');
            if (passwordInput === EDIT_PASSWORD) {
                isAuthenticated = true;
                alert('‚úÖ ÂØÜÁ¢ºÊ≠£Á¢∫ÔºåÂ∑≤ÈñãÂïüÁ∑®ËºØÊ¨äÈôêÔºÅ');
                return true;
            } else if (passwordInput !== null) {
                alert('‚ùå ÂØÜÁ¢ºÈåØË™§ÔºåÁÑ°Ê≥ïÈÄ≤Ë°åÁ∑®ËºØÊìç‰ΩúÔºÅ');
            }
            return false;
        }
        function updateConnectionStatus(status, connected) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = status;
            statusEl.className = connected ? 'status connected' : 'status';
            
            // Êõ¥Êñ∞Ë≥áË®äÈ°ØÁ§∫
            if (connected) {
                document.querySelector('.grid-info').textContent = '‚úÖ Âç≥ÊôÇÂçî‰ΩúÂ∑≤ÂïüÁî®';
            } else {
                document.querySelector('.grid-info').textContent = '‚ö†Ô∏è ÈúÄË¶ÅË®≠ÂÆö Firebase ÊâçËÉΩ‰ΩøÁî®Âç≥ÊôÇÂçî‰ΩúÂäüËÉΩ';
            }
        }

        function saveToFirebase() {
            if (!isFirebaseEnabled || isUpdatingFromFirebase) return;
            
            try {
                const layoutRef = ref(database, 'bearDenLayout');
                set(layoutRef, {
                    people: people,
                    lastUpdated: Date.now()
                });
            } catch (error) {
                console.warn('Firebase ÂÑ≤Â≠òÂ§±Êïó:', error);
            }
        }

        function setupFirebaseListener() {
            if (!isFirebaseEnabled) return;
            
            const layoutRef = ref(database, 'bearDenLayout');
            onValue(layoutRef, (snapshot) => {
                const data = snapshot.val();
                
                isUpdatingFromFirebase = true;
                
                if (data && data.people && data.people.length > 0) {
                    // ‚úÖ Firebase ÊúâË≥áÊñôÔºå‰ΩøÁî® Firebase ÁöÑË≥áÊñô
                    people = data.people;
                    hasLoadedFromFirebase = true;
                } else if (!hasLoadedFromFirebase) {
                    // ‚úÖ Firebase Ê≤íÊúâË≥áÊñô‰∏îÊòØÁ¨¨‰∏ÄÊ¨°ËºâÂÖ•Ôºå‰ΩøÁî®È†êË®≠Ë≥áÊñô‰∏¶ÂÑ≤Â≠òÂà∞ Firebase
                    people = [...defaultPeople];
                    hasLoadedFromFirebase = true;
                    // Â∞áÈ†êË®≠Ë≥áÊñôÂÑ≤Â≠òÂà∞ Firebase
                    setTimeout(() => {
                        isUpdatingFromFirebase = false;
                        saveToFirebase();
                    }, 100);
                }
                
                renderPeople();
                isUpdatingFromFirebase = false;
            });
        }

        // üî• Ëß∏ÊéßÂèçÈ•ãÂáΩÊï∏
        function showTouchFeedback(element, show = true) {
            if (show) {
                element.classList.add('touch-active');
                // Ëß∏ÊéßÈúáÂãïÂèçÈ•ãÔºàÂ¶ÇÊûúÊîØÊè¥Ôºâ
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } else {
                element.classList.remove('touch-active');
            }
        }
        
        function showDragHint(show = true) {
            const hint = document.getElementById('touchHint');
            if (show) {
                hint.classList.add('show');
            } else {
                hint.classList.remove('show');
            }
        }
        
        // üéØ ÂâµÂª∫ÊãñÊãΩËªåË∑°Èªû
        function createDragTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'drag-trail';
            trail.style.left = x + 'px';
            trail.style.top = y + 'px';
            document.getElementById('mapContainer').appendChild(trail);
            
            // 1ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                if (trail.parentNode) {
                    trail.parentNode.removeChild(trail);
                }
            }, 1000);
        }

        // Â∫ßÊ®ôËΩâÊèõÂáΩÊï∏
        function gridToPixel(gridX, gridY) {
            const gridStep = 40;
            const rotatedX = (gridX - gridY) * gridStep / 2;
            const rotatedY = (gridX + gridY) * gridStep / 2;
            
            return {
                x: GRID_ORIGIN_X + rotatedX,
                y: GRID_ORIGIN_Y + rotatedY
            };
        }
        
        function pixelToGrid(pixelX, pixelY) {
            const deltaX = pixelX - GRID_ORIGIN_X;
            const deltaY = pixelY - GRID_ORIGIN_Y;
            const gridStep = 40;
            
            const gridX = Math.round((deltaX + deltaY) / gridStep);
            const gridY = Math.round((deltaY - deltaX) / gridStep);
            
            return {gridX, gridY};
        }
        
        // Ê∏≤ÊüìÂáΩÊï∏
        function renderPeople() {
            const container = document.getElementById('mapContainer');
            
            const existingPeople = container.querySelectorAll('.person');
            existingPeople.forEach(p => p.remove());
            
            document.getElementById('peopleCount').textContent = people.length;
            
            people.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `person ${item.color || 'green'}`;
                div.dataset.index = index;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'text';
                textDiv.textContent = item.name;
                div.appendChild(textDiv);
                
                const gridSpacing = 40;
                let size;
                
                switch(item.type) {
                    case 'small':
                        size = gridSpacing * Math.sqrt(2);
                        break;
                    case 'person':
                        size = gridSpacing * 2 * Math.sqrt(2);
                        break;
                    case 'center':
                        size = gridSpacing * 3 * Math.sqrt(2);
                        break;
                    case 'large':
                        size = gridSpacing * 4 * Math.sqrt(2);
                        break;
                    default:
                        size = gridSpacing * 2 * Math.sqrt(2);
                }
                
                const centerPos = gridToPixel(item.gridX, item.gridY);
                
                div.style.width = size + 'px';
                div.style.height = size + 'px';
                div.style.left = (centerPos.x - size/2) + 'px';
                div.style.top = (centerPos.y - size/2) + 'px';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '√ó';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteItem(index);
                };
                div.appendChild(deleteBtn);
                
                // Âè≥ÈçµÊîπËâ≤
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    changeColor(index);
                });
                
                // üî• Êñ∞ÁöÑËß∏Êéß‰∫ã‰ª∂ËôïÁêÜ
                setupTouchEvents(div, index);
                
                container.appendChild(div);
            });
            
            // Â¶ÇÊûú‰∏çÊòØÂæû Firebase Êõ¥Êñ∞ÔºåÂâáÂÑ≤Â≠òÂà∞ Firebase
            if (!isUpdatingFromFirebase) {
                saveToFirebase();
            }
        }

        // üéØ Ë®≠ÂÆöËß∏Êéß‰∫ã‰ª∂
        function setupTouchEvents(element, index) {
            let touchStarted = false;
            
            // Ëß∏ÊéßÈñãÂßã
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                touchStarted = true;
                currentTouchTarget = element;
                touchStartTime = Date.now();
                
                // Á´ãÂç≥È°ØÁ§∫Ëß∏ÊéßÂèçÈ•ã
                showTouchFeedback(element, true);
                
                // Ë®≠ÂÆöÈï∑ÊåâË®àÊôÇÂô®
                longPressTimer = setTimeout(() => {
                    if (touchStarted) {
                        startDragMode(e, index);
                    }
                }, 200); // 200ms Èï∑ÊåâËß∏ÁôºÊãñÊãΩ
                
            }, { passive: false });
            
            // Ëß∏ÊéßÁßªÂãï - Èò≤Ê≠¢ÊÑèÂ§ñÁµêÊùü
            element.addEventListener('touchmove', (e) => {
                if (touchStarted && longPressTimer) {
                    // Â¶ÇÊûúÈÇÑÂú®Èï∑ÊåâË®àÊôÇ‰∏≠Ôºå‰∏çË¶ÅÂèñÊ∂à
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, { passive: false });
            
            // Áü≠ÈªûÊìäËôïÁêÜ
            element.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const touchDuration = Date.now() - touchStartTime;
                touchStarted = false;
                
                // Ê∏ÖÈô§Èï∑ÊåâË®àÊôÇÂô®
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // ÁßªÈô§Ëß∏ÊéßÂèçÈ•ã
                showTouchFeedback(element, false);
                
                // Âè™ÊúâÂú®ÈùûÊãñÊãΩÁãÄÊÖã‰∏ãÊâçÁµêÊùüÊãñÊãΩ
                if (isDragging && touchDuration > 200) {
                    // ÊãñÊãΩ‰∏≠ÁöÑ touchendÔºå‰∏çË¶ÅÁ´ãÂç≥ÁµêÊùü
                    return;
                }
                
                currentTouchTarget = null;
            });
            
            // Ëß∏ÊéßÂèñÊ∂àËôïÁêÜ
            element.addEventListener('touchcancel', (e) => {
                touchStarted = false;
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                showTouchFeedback(element, false);
            });
            
            // ÊªëÈº†‰∫ã‰ª∂ÔºàÊ°åÈù¢Ôºâ
            element.addEventListener('mousedown', (e) => {
                startDragMode(e, index);
            });
        }
        
        // üéØ ÈñãÂßãÊãñÊãΩÊ®°Âºè
        function startDragMode(e, index) {
            updateDebugInfo('üîê Ê™¢Êü•Á∑®ËºØÊ¨äÈôê...');
            
            // üîê Ê™¢Êü•Á∑®ËºØÊ¨äÈôê
            if (!checkEditPassword()) {
                showDragHint(false);
                updateDebugInfo('‚ùå Ê¨äÈôêË¢´ÊãíÁµï');
                return;
            }
            
            updateDebugInfo('‚úÖ Ê¨äÈôêÈÄöÈÅéÔºåÈñãÂßãÊãñÊãΩ...');
            
            if (isDragging) return;
            if (e.target.classList.contains('delete-btn')) return;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            isDragging = true;
            dragPerson = index;
            
            const element = document.querySelector(`[data-index="${index}"]`);
            const rect = element.getBoundingClientRect();
            
            // üî• ‰øÆÊ≠£ÔºöË®àÁÆóÁõ∏Â∞çÊñºÂÆπÂô®ÁöÑÂÅèÁßª
            const container = document.getElementById('mapContainer');
            const containerRect = container.getBoundingClientRect();
            
            dragOffset.x = clientX - (rect.left + rect.width/2);
            dragOffset.y = clientY - (rect.top + rect.height/2);
            
            element.classList.add('dragging');
            showDragHint(true);
            
            // Ëß∏ÊéßÈúáÂãï
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            updateDebugInfo(`üéØ ÊãñÊãΩÈñãÂßã: ${people[index].name}<br/>ÁãÄÊÖã: ${isDragging ? 'ÊãñÊãΩ‰∏≠' : 'Êú™ÊãñÊãΩ'}`);
            
            e.preventDefault();
            e.stopPropagation();
        }
        
        // üéØ ÁµêÊùüÊãñÊãΩ
        function endDrag() {
            if (!isDragging) return;
            
            updateDebugInfo('üéØ ÁµêÊùüÊãñÊãΩ');
            
            isDragging = false;
            showDragHint(false);
            
            document.querySelectorAll('.person').forEach(p => {
                p.classList.remove('dragging');
            });
            
            dragPerson = null;
            
            // 3ÁßíÂæåÊÅ¢Âæ©Ê≠£Â∏∏È°ØÁ§∫
            setTimeout(() => {
                if (!isDragging) {
                    updateDebugInfo('‚úÖ Âç≥ÊôÇÂçî‰ΩúÂ∑≤ÂïüÁî®<br/>üîß Èô§ÈåØÊ®°Âºè');
                }
            }, 3000);
        }

        // Á∏ÆÊîæÂäüËÉΩ
        function applyZoom() {
            const container = document.getElementById('mapContainer');
            const containerRect = container.getBoundingClientRect();
            const viewportCenterX = window.innerWidth / 2;
            const viewportCenterY = window.innerHeight / 2;
            
            const containerCenterX = (viewportCenterX - containerRect.left) / zoomLevel;
            const containerCenterY = (viewportCenterY - containerRect.top) / zoomLevel;
            
            container.style.transformOrigin = `${containerCenterX}px ${containerCenterY}px`;
            container.style.transform = `scale(${zoomLevel})`;
            
            document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
        }
        
        window.zoomIn = function() {
            if (zoomLevel < 3.0) {
                zoomLevel *= 1.2;
                applyZoom();
            }
        }
        
        window.zoomOut = function() {
            if (zoomLevel > 0.1) {
                zoomLevel /= 1.2;
                applyZoom();
            }
        }
        
        window.resetZoom = function() {
            zoomLevel = 1.0;
            applyZoom();
        }

        // ÂäüËÉΩÂáΩÊï∏
        window.addItem = function() {
            // üîê Ê™¢Êü•Á∑®ËºØÊ¨äÈôê
            if (!checkEditPassword()) return;
            
            const nameInput = document.getElementById('newItemName');
            const typeSelect = document.getElementById('itemType');
            const colorSelect = document.getElementById('itemColor');
            const name = nameInput.value.trim();
            const type = typeSelect.value;
            const color = colorSelect.value;
            
            if (name) {
                people.push({
                    name: name,
                    gridX: 6,
                    gridY: 6,
                    type: type,
                    color: color
                });
                nameInput.value = '';
                renderPeople();
            }
        }

        function deleteItem(index) {
            // üîê Ê™¢Êü•Á∑®ËºØÊ¨äÈôê
            if (!checkEditPassword()) return;
            
            // üõ°Ô∏è Âà™Èô§ÂñÆÂÄãÈ†ÖÁõÆÁöÑÁ¢∫Ë™çÔºàÁßªÈô§ÁÜäÁ™©‰øùË≠∑Ôºâ
            const itemName = people[index].name;
            const itemType = people[index].type;
            
            // üî• ÈáçË¶ÅÈ†ÖÁõÆÈ°çÂ§ñÁ¢∫Ë™ç
            if (itemType === 'center' || itemName === 'ÁÜäÁ™©') {
                const extraConfirm = confirm(`‚ö†Ô∏è Ê≥®ÊÑèÔºÅ‰Ω†Ë¶ÅÂà™Èô§ÁöÑÊòØÈáçË¶ÅÂª∫ÁØâ "${itemName}"ÔºÅ\n\nÁ¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü`);
                if (!extraConfirm) return;
            }
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ "${itemName}" ÂóéÔºü`)) {
                people.splice(index, 1);
                renderPeople();
            }
        }

        function changeColor(index) {
            // üîê Ê™¢Êü•Á∑®ËºØÊ¨äÈôê
            if (!checkEditPassword()) return;
            
            const colors = ['green', 'blue', 'purple', 'orange', 'pink', 'yellow', 'cyan', 'red'];
            const currentColor = people[index].color || 'green';
            const currentIndex = colors.indexOf(currentColor);
            const nextIndex = (currentIndex + 1) % colors.length;
            
            people[index].color = colors[nextIndex];
            renderPeople();
        }

        window.exportLayout = function() {
            const layout = people.map(p => {
                const typeNames = {
                    'small': 'Â∞èÂª∫ÁØâ(1√ó1=1Ê†º)',
                    'person': 'ÊàêÂì°(2√ó2=4Ê†º)', 
                    'center': '‰∏≠ÂøÉÂª∫ÁØâ(3√ó3=9Ê†º)',
                    'large': 'Â§ßÂª∫ÁØâ(4√ó4=16Ê†º)'
                };
                return `${p.name}: ${typeNames[p.type]} Ê†ºÁ∑ö(${p.gridX}, ${p.gridY}) È°èËâ≤:${p.color}`;
            }).join('\n');
            const blob = new Blob([layout], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Â∫ß‰ΩçÂÆâÊéí_Ê†ºÁ∑öÂ∫ßÊ®ô.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        window.clearAll = function() {
            // üîê ÂÖàÊ™¢Êü•Á∑®ËºØÊ¨äÈôê
            if (!checkEditPassword()) return;
            
            // üîê ÂØÜÁ¢º‰øùË≠∑ + ‰∏âÈáçÁ¢∫Ë™ç‰øùË≠∑Ê©üÂà∂
            const CLEAR_PASSWORD = "SKY1147dean"; // ‰Ω†ÂèØ‰ª•‰øÆÊîπÈÄôÂÄãÂØÜÁ¢º
            const itemCount = people.length;
            
            // Á¨¨‰∏ÄÊ≠•ÔºöÂØÜÁ¢ºÈ©óË≠â
            const passwordInput = prompt('üîê Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂì°ÂØÜÁ¢ºÊâçËÉΩÊ∏ÖÁ©∫ÊâÄÊúâÈ†ÖÁõÆÔºö');
            if (passwordInput !== CLEAR_PASSWORD) {
                alert('‚ùå ÂØÜÁ¢ºÈåØË™§ÔºåÊìç‰ΩúÂ∑≤ÂèñÊ∂à');
                return;
            }
            
            if (itemCount <= 4) {
                if (confirm('‚úÖ ÂØÜÁ¢ºÊ≠£Á¢∫ÔºÅ\n\nÁ¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÈ†ÖÁõÆÂóéÔºü')) {
                    people = [];
                    renderPeople();
                    alert('‚úÖ ÊâÄÊúâÈ†ÖÁõÆÂ∑≤Ê∏ÖÁ©∫');
                }
            } else {
                // È†ÖÁõÆÂæàÂ§öÊôÇÁöÑÁâπÊÆä‰øùË≠∑
                const firstConfirm = confirm(`‚úÖ ÂØÜÁ¢ºÊ≠£Á¢∫ÔºÅ\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºÅ‰Ω†Âç≥Â∞áÂà™Èô§ ${itemCount} ÂÄãÈ†ÖÁõÆÔºÅ\n\nÈÄôÂÄãÊìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`);
                if (!firstConfirm) return;
                
                const secondConfirm = confirm('üö® ÊúÄÂæåÁ¢∫Ë™çÔºÅ\n\nÁúüÁöÑË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ∫ß‰ΩçÂÆâÊéíÂóéÔºü');
                if (!secondConfirm) return;
                
                const userInput = prompt(`Ë´ãËº∏ÂÖ•Áï∂ÂâçÈ†ÖÁõÆÊï∏Èáè "${itemCount}" ‰æÜÊúÄÁµÇÁ¢∫Ë™çÊ∏ÖÁ©∫Êìç‰ΩúÔºö`);
                if (userInput === itemCount.toString()) {
                    people = [];
                    renderPeople();
                    alert('‚úÖ ÊâÄÊúâÈ†ÖÁõÆÂ∑≤Ê∏ÖÁ©∫');
                } else {
                    alert('‚ùå Êï∏Èáè‰∏çÊ≠£Á¢∫ÔºåÊìç‰ΩúÂ∑≤ÂèñÊ∂à');
                }
            }
        }

        // üéØ ÂÖ®ÂüüËß∏ÊéßÁßªÂãïËôïÁêÜ
        document.addEventListener('touchmove', (e) => {
            if (!isDragging || dragPerson === null) return;
            
            // üî• ÈáçË¶ÅÔºöÈò≤Ê≠¢È†ÅÈù¢ÊªæÂãïÂíåÂÖ∂‰ªñËß∏ÊéßË°åÁÇ∫
            e.preventDefault();
            e.stopPropagation();
            
            const container = document.getElementById('mapContainer');
            const rect = container.getBoundingClientRect();
            
            const clientX = e.touches[0].clientX;
            const clientY = e.touches[0].clientY;
            
            // üî• ‰øÆÊ≠£ÔºöÊ≠£Á¢∫Ë®àÁÆóÊñ∞‰ΩçÁΩÆ
            const newCenterX = clientX - dragOffset.x;
            const newCenterY = clientY - dragOffset.y;
            
            // ËΩâÊèõÁÇ∫ÂÆπÂô®ÂÖßÁöÑÂ∫ßÊ®ô
            const containerX = newCenterX - rect.left;
            const containerY = newCenterY - rect.top;
            
            const newGrid = pixelToGrid(containerX, containerY);
            
            // üî• Áõ¥Êé•Êõ¥Êñ∞‰ΩçÁΩÆ
            people[dragPerson].gridX = newGrid.gridX;
            people[dragPerson].gridY = newGrid.gridY;
            
            updateDebugInfo(`üéØ ÊãñÊãΩÁßªÂãï‰∏≠<br/>Ê†ºÁ∑ö: (${newGrid.gridX}, ${newGrid.gridY})<br/>ÁãÄÊÖã: ${isDragging ? 'ÊãñÊãΩ‰∏≠' : 'Êú™ÊãñÊãΩ'}`);
            
            renderPeople();
            
            // üî• ÂâµÂª∫ÊãñÊãΩËªåË∑°
            createDragTrail(containerX, containerY);
            
            // Êõ¥Êñ∞Â∫ßÊ®ôÈ°ØÁ§∫
            document.getElementById('coords').textContent = 
                `üéØ ÊãñÊãΩ‰∏≠: Ê†ºÁ∑ö(${newGrid.gridX}, ${newGrid.gridY})`;
                
        }, { passive: false });
        
        // üéØ ÂÖ®ÂüüËß∏ÊéßÁµêÊùüËôïÁêÜ
        document.addEventListener('touchend', (e) => {
            // Âè™ÊúâÂú®ÁúüÊ≠£ÊãñÊãΩ‰∏≠ÊâçÁµêÊùü
            if (isDragging && dragPerson !== null) {
                setTimeout(() => {
                    endDrag();
                }, 50); // Á®çÂæÆÂª∂ÈÅ≤ÔºåÈÅøÂÖçÈÅéÊó©ÁµêÊùü
            }
        }, { passive: false });

        // ‰∫ã‰ª∂Áõ£ËÅΩÂô® - ÊîØÊè¥Ëß∏Êéß
        function setupEventListeners() {
            const handleMove = (e) => {
                const container = document.getElementById('mapContainer');
                const rect = container.getBoundingClientRect();
                
                // ÊîØÊè¥Ëß∏ÊéßÂíåÊªëÈº†
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const pixelX = clientX - rect.left;
                const pixelY = clientY - rect.top;
                const grid = pixelToGrid(pixelX, pixelY);
                
                if (!isDragging) {
                    document.getElementById('coords').textContent = 
                        `Â∫ßÊ®ô: ${Math.round(pixelX)}, ${Math.round(pixelY)} | Ê†ºÁ∑ö: (${grid.gridX}, ${grid.gridY})`;
                }
                
                if (isDragging && dragPerson !== null) {
                    const newPixelX = clientX - rect.left - dragOffset.x;
                    const newPixelY = clientY - rect.top - dragOffset.y;
                    const newGrid = pixelToGrid(newPixelX, newPixelY);
                    
                    people[dragPerson].gridX = newGrid.gridX;
                    people[dragPerson].gridY = newGrid.gridY;
                    
                    renderPeople();
                    
                    // üî• ÂâµÂª∫ÊãñÊãΩËªåË∑°
                    createDragTrail(newPixelX, newPixelY);
                }
            };
            
            const handleEnd = () => {
                if (isDragging) {
                    setTimeout(() => {
                        endDrag();
                    }, 10);
                }
            };
            
            // ÊªëÈº†‰∫ã‰ª∂
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            
            // Ëß∏Êéß‰∫ã‰ª∂
            // ÁßªÈô§ÂéüÊú¨ÁöÑ touchend Áõ£ËÅΩÔºåÈÅøÂÖçË°ùÁ™Å
        }

        // ÈçµÁõ§Âø´Êç∑Èçµ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('newItemName') === document.activeElement) {
                window.addItem();
            }
            else if (e.key === '=' || e.key === '+') {
                e.preventDefault();
                window.zoomIn();
            }
            else if (e.key === '-' || e.key === '_') {
                e.preventDefault();
                window.zoomOut();
            }
            else if (e.key === '0' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                window.resetZoom();
            }
        });

        // ÊªëÈº†ÊªæËº™Á∏ÆÊîæ
        document.getElementById('mapContainer').addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    window.zoomIn();
                } else {
                    window.zoomOut();
                }
            }
        });

        // ÂàùÂßãÂåñ
        function initialize() {
            applyZoom();
            
            const centerX = MAP_WIDTH / 2 - window.innerWidth / 2;
            const centerY = MAP_HEIGHT / 2 - window.innerHeight / 2;
            
            window.scrollTo(centerX, centerY);
            
            // ‚úÖ Ë®≠ÂÆö Firebase Áõ£ËÅΩÂô®ÔºàÊúÉËá™ÂãïËºâÂÖ•Ë≥áÊñôÔºâ
            setupFirebaseListener();
            
            // Ë®≠ÂÆö‰∫ã‰ª∂Áõ£ËÅΩÂô®
            setupEventListeners();
        }

        initialize();
    </script>
</body>
</html>